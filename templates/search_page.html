<script>
    // ... [Keep your existing code above] ...

    // 1. ADD THIS HELPER FUNCTION TO PREVENT HTML BREAKAGE
    function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        return String(text)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // 2. UPDATE buildValueHtml TO USE ESCAPING
    function buildValueHtml(value) {
        let valueHtml = '';
        if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
            valueHtml = renderNestedObject(value);
        } else if (Array.isArray(value)) {
            valueHtml = `<div class="pl-4 mt-2 space-y-2">${value.map(item => `<div>${buildValueHtml(item)}</div>`).join('')}</div>`;
        } else {
            // Clean and Escape the value
            let displayValue = (value || '').toString().replace(/!/g, ', ').replace(/\s*,\s*/g, ', ').replace(/^,\s*/, '').trim();
            valueHtml = `<span class="result-value">${escapeHtml(displayValue)}</span>`;
        }
        return valueHtml;
    }

    // 3. REPLACE YOUR displayResults FUNCTION WITH THIS SAFER VERSION
    function displayResults(result) {
        resultContainer.innerHTML = '';
        if (result.status !== 'success') {
             displayError(result.error || 'Failed to retrieve data.');
             return;
        }
        const allKeys = Object.keys(result);
        const dataKeys = allKeys.filter(k => !['status', 'key_status', 'dev'].includes(k));
        if (dataKeys.length === 0 && isDataEmpty(result)) {
             displayError('No data found for this query.');
             return;
        }
        
        let htmlContent = '';
        let plainTextContent = `Search Results for: ${numberInput.value}\n===================================\n`;
        const resultId = 'result-text-0';
        
        // ... [Keep your existing buildResultCard function, but ensure it calls the updated buildValueHtml] ...
        // Note: For buildResultCard, ensure you use escapeHtml(cleanValue) when rendering the text span.

        // [Reuse your existing buildResultCard logic here]
        const sanitizeError = (errorMsg) => {
            let msg = String(errorMsg);
            if (msg.toLowerCase().includes('http') || msg.toLowerCase().includes('network') || msg.toLowerCase().includes('failed to fetch')) {
                return 'Data source is unavailable or timed out.';
            }
            return escapeHtml(msg); // Escape error messages too
        };

        const getPlainTextValue = (v) => {
            if (typeof v === 'object' && v !== null && !Array.isArray(v)) {
                return Object.entries(v)
                    .map(([objK, objV]) => {
                        if (junkKeys.includes(objK.toLowerCase())) return '';
                        return `${prettyKey(objK)}: ${getPlainTextValue(objV)}`;
                    })
                    .filter(s => s)
                    .join(', ');
            } else if (Array.isArray(v)) {
                return v.map(item => getPlainTextValue(item)).join(', ');
            }
            return String(v).replace(/!/g, ', ').replace(/\s*,\s*/g, ', ').replace(/^,\s*/, '').trim();
        };

        // Redefine buildResultCard to be safe (copy this inside displayResults or make it global)
        const buildResultCard = (title, item) => {
            let cardHtml = `<div class="result-card">`;
            let cardBody = '';
            let plainTextBody = '';
            
            if (item.error) {
                const cleanError = sanitizeError(item.error);
                cardHtml += `<div class="result-title text-red-400">${title} (Error)</div>`;
                cardBody = `<div class="result-body text-red-300">${cleanError}</div>`;
                plainTextBody = `Error: ${item.error}\n`;
            } else if (isDataEmpty(item)) {
                cardHtml += `<div class="result-title text-cyan-400">${title}</div>`;
                cardBody = `<div class="result-body text-gray-400">No information found from this source.</div>`;
                plainTextBody = `No information found.\n`;
            } else {
                cardHtml += `<div class="result-title text-cyan-400">${title}</div>`;
                let gridHtml = '';
                
                const allItemKeys = Object.keys(item);
                const sortedKeys = [...priorityKeys.filter(k => allItemKeys.includes(k)), ...allItemKeys.filter(k => !priorityKeys.includes(k))];

                for (const key of sortedKeys) {
                    const value = item[key];
                    let valueString = String(value).toLowerCase(); 
                    let isJunk = junkValues.some(junk => valueString.includes(junk.toLowerCase()));
                    
                    if (value === null || value === 'NA' || value === '' || isJunk || junkKeys.includes(key.toLowerCase())) { 
                        continue;
                    }

                    let cleanValue = getPlainTextValue(value);
                    if (!cleanValue) continue;
                    
                    plainTextBody += `${prettyKey(key)}: ${cleanValue}\n`; 
                    
                    gridHtml += `<div class="result-item">`;
                    gridHtml += `<span class="result-key">${prettyKey(key)}</span>`;
                    
                    if (key.toLowerCase() === 'image' && typeof value === 'string' && value.startsWith('http')) {
                        gridHtml += `<span class="result-value"><img src="${value}" alt="Vehicle Image"></span>`;
                    } 
                    else if (typeof value === 'object' && value !== null) {
                         gridHtml += buildValueHtml(value);
                    }
                    else {
                        let valueClass = priorityKeys.includes(key) ? 'result-value priority' : 'result-value';
                        // ESCAPE THE VALUE HERE
                        gridHtml += `<span class="${valueClass}">${escapeHtml(cleanValue)}</span>`;
                    }
                    gridHtml += `</div>`;
                }
                cardBody = `<div class="result-body"><div class="grid grid-cols-1 md:grid-cols-2 gap-3">${gridHtml}</div></div>`;
            }
            
            cardHtml += cardBody + `</div>`;
            return {html: cardHtml, text: plainTextBody};
        };
        
        // --- Main rendering logic ---
        if (SERVICE_TYPE === 'phone' || SERVICE_TYPE === 'vehicle') {
            dataKeys.forEach((key, index) => {
                const item = result[key];
                if (typeof item !== 'object' || item === null) return;
                
                const title = `Source ${index + 1}`;
                const {html, text} = buildResultCard(title, item);
                htmlContent += html;
                plainTextContent += `\n--- ${title} ---\n${text}`;
            });
        } else {
            const title = `Result`;
            const {html, text} = buildResultCard(title, result);
            htmlContent += html;
            plainTextContent += `--- Result ---\n${text}`;
        }

        if (result.key_status) {
            htmlContent += `<div class="text-sm text-gray-500 mt-2 flex flex-wrap justify-between gap-2"><span>Searches Left: <span class="text-green-400 font-medium">${result.key_status.searches_left}</span></span><span>Key Expires: <span class="text-gray-400 font-medium">${result.key_status.expiry_date}</span></span></div>`;
        }
        
        htmlContent += `<div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">`;
        htmlContent += `<button id="copy-all-btn" class="w-full p-3 bg-gray-600 hover:bg-gray-500 rounded-lg font-bold text-white transition-all shadow-lg flex items-center justify-center" data-target="${resultId}"><i class="fas fa-copy mr-2"></i>Copy All Results</button>`;
        htmlContent += `<button id="download-pdf-btn" class="w-full p-3 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold text-white transition-all shadow-lg flex items-center justify-center" data-target="${resultId}"><i class="fas fa-file-pdf mr-2"></i>Download as PDF</button>`;
        htmlContent += `<button id="searchAgainBtn" class="w-full p-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold text-white transition-all shadow-lg flex items-center justify-center"><i class="fas fa-search mr-2"></i>Search Again</button>`;
        htmlContent += `</div>`;
        
        htmlContent += `<textarea id="${resultId}" class="hidden">${plainTextContent.trim()}\n\nDeveloper: RAHUL SHARMA</textarea>`;

        resultContainer.innerHTML = htmlContent;

        // --- SAFE EVENT LISTENERS (The Fix for the Null Error) ---
        const copyBtn = document.getElementById('copy-all-btn');
        if (copyBtn) {
            copyBtn.addEventListener('click', (e) => {
                const button = e.currentTarget; 
                const targetEl = document.getElementById(button.dataset.target);
                if (!targetEl) return;
                const textToCopy = targetEl.value;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    button.innerHTML = '<i class="fas fa-check mr-1"></i>Copied!'; 
                    button.classList.add('bg-green-700', 'text-white');
                    setTimeout(() => { 
                        button.innerHTML = '<i class="fas fa-copy mr-1"></i>Copy All Results'; 
                        button.classList.remove('bg-green-700', 'text-white'); 
                    }, 2000);
                });
            });
        }

        const pdfBtn = document.getElementById('download-pdf-btn');
        if (pdfBtn) {
            pdfBtn.addEventListener('click', (e) => handleDownloadPDF(e.currentTarget));
        }

        const againBtn = document.getElementById('searchAgainBtn');
        if (againBtn) {
            againBtn.addEventListener('click', handleSearchAgain);
        }
    }
</script>
